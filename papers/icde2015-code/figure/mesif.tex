% Author: Marek Fiser <tikz at marekfiser.cz>
% MESIF protocol: http://en.wikipedia.org/wiki/MESIF_protocol
\documentclass[tikz, border=10pt]{standalone}
%%%<
\usepackage{verbatim}
\usetikzlibrary{fit}					% fitting shapes to coordinates
\usetikzlibrary{backgrounds}	% drawing the background after the foreground

%%%>
\begin{comment}
:Title: MESIF protocol
:Tags: Diagrams;Block diagrams;Computer science
:Author: Marek Fiser
:Slug: mesif

A diagram describing the MESIF protocol: http://en.wikipedia.org/wiki/MESIF_protocol
\end{comment}
\usetikzlibrary{arrows}
\begin{document}
% The control input vector is represented by a purple circle.
\tikzstyle{latent}=[circle,
                                    thick,
                                    font=\sffamily\Large\bfseries,
                                    minimum size=14mm,
                                    draw=purple!80,
                                    fill=purple!20]
                                  
% Everything is drawn on underlying gray rectangles with
% rounded corners.
\tikzstyle{background}=[rectangle,
                                                draw=gray!90,
                                                inner sep=0.2cm,
                                                rounded corners=5mm]

\tikzset{
    state/.style={
           rectangle,
           rounded corners,
           draw=black, very thick,
           minimum height=2em,
           inner sep=2pt,
           text centered,
           },
}
                                       
\begin{tikzpicture}[->,>=stealth',shorten >=1pt,auto,node distance=3cm,
  thick,main node/.style={circle,fill=blue!20,draw,
  font=\sffamily\Large\bfseries,minimum size=14mm}]

  \node[main node] (d) {d};
  \node[latent] (z) [below of=d] {z};
  \node[main node] (iw) [right of=z] {w};
  \node[main node] (cw) [below of=z] {w};
  \node[main node] (l) [below of=iw] {l};
  \node[main node] (a) [left of=d] {a};
  \node[latent] (cz) [below of=a] {z};
  \node[main node] (c) [left of=cz] {c};
  \node[main node] (w) [below of=cz] {w};

  \path[every node/.style={font=\sffamily\small,
  		fill=white,inner sep=1pt}]
  	% Right-hand-side arrows rendered from top to bottom to
  	% achieve proper rendering of labels over arrows
        
  	% Left-hand-side arrows rendered from bottom to top to
  	% achieve proper rendering of labels over arrows.
    (d) edge (z)
        edge (a)
        edge (cz)
    (z) edge (iw)
        edge (cw)
        edge (z)
    (l) edge (iw)
    (c) edge (a)
    	edge (w)
    (a) edge (cz)
    (cz) edge (w);
    \begin{pgfonlayer}{background}
    \node [background,
                    fit=(d) (l)
                    ] (file){};
    \node [background,
                    fit=(c) (w),
                    label=below:$commits$] {};
    \node [background,
                    fit=(d) (l),
                    label=below:$files$] {};
    \node [background,
                    fit=(z) (cw),
                    label=below:$N$] {};
    \node [background,
                    fit=(z) (iw),
                    label=below:$N$] {};
    \node [background,
                    fit=(cz) (w),
                    label=below:$N$] {};
    \end{pgfonlayer}
%    \node[state] (ann)[right of=iw]{
%    {\begin{tabular}{l}
%  		\textbf{Annotation}\\
%  		\\[1em]
%  		\parbox{2cm}{
%		   \textbf{d:file}\\
%		   \textbf{z:topic}\\
%		   \textbf{w:word}\\
%		   \textbf{l:language}\\
%		   \textbf{c:commit}\\
%		   \textbf{a:connection}\\
%  }\\[4em]
% \end{tabular}}
%    };
    
\end{tikzpicture}
\end{document}
